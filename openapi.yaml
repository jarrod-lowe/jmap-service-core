openapi: 3.0.1
info:
  title: Minimal JMAP Mail API (MVP) - API Gateway
  version: 0.4.0
  description: |
    MVP goal:
      - Ingest inbound email (machine principal, AWS_IAM SigV4).
      - Allow a user to view their emails (Cognito User Pool JWT).
      - No threads, no submission, no mailbox management, no push.

    JMAP endpoints included:
      - GET /.well-known/jmap  (Session discovery)
      - POST /jmap             (JMAP API for user clients)
      - POST /jmap-iam/{accountId} (JMAP API for machine ingest, AWS_IAM, accountId in path)

    Notes:
      - This spec describes the HTTP surface and API Gateway integrations.
      - JMAP request/response bodies are intentionally modelled minimally (envelope only) for the MVP.

x-amazon-apigateway-importexport-version: "1.0"

servers:
  - url: https://{apiId}.execute-api.{region}.amazonaws.com/{stage}
    variables:
      apiId:
        default: example
      region:
        default: ap-southeast-2
      stage:
        default: v1

tags:
  - name: jmap
    description: JMAP Session discovery and JMAP API endpoints.

paths:
  /.well-known/jmap:
    get:
      tags: [jmap]
      operationId: getJmapSession
      summary: JMAP Session discovery (authenticated)
      description: |
        Returns the JMAP Session object. This endpoint is authenticated so the server can return
        the correct account list for the caller.

        MVP behavior:
          - Returns exactly one account whose accountId is the Cognito user's `sub`.
          - apiUrl points to /jmap (Cognito-authenticated route).
      security:
        - CognitoUserPool: []
      responses:
        "200":
          description: JMAP Session object
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/JmapSession"
              examples:
                singleAccount:
                  value:
                    apiUrl: "https://example.execute-api.ap-southeast-2.amazonaws.com/v1/jmap"
                    state: "session_1"
                    capabilities:
                      urn:ietf:params:jmap:core: {}
                      urn:ietf:params:jmap:mail: {}
                    accounts:
                      6f4c9e2a-8d9f-4c1e-b7a2-4d9c1f6e9e2a:
                        name: "Primary"
                        isPersonal: true
                        isReadOnly: false
                        accountCapabilities:
                          urn:ietf:params:jmap:mail: {}
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalError"
      x-amazon-apigateway-integration:
        type: aws_proxy
        httpMethod: POST
        uri:
          Fn::Sub: >-
            arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${GetJmapSessionFunction.Arn}/invocations
        payloadFormatVersion: "2.0"

  /jmap:
    post:
      tags: [jmap]
      operationId: jmapApiUser
      summary: JMAP API endpoint (user, Cognito)
      description: |
        JMAP API endpoint for end-user clients.

        MVP supported methods (server contract):
          - Email/query
          - Email/get

        Server rules:
          - For Cognito-authenticated callers, the effective accountId is the JWT `sub`.
          - If a method includes `accountId`, it must match the effective accountId (or is rejected).
      security:
        - CognitoUserPool: []
      x-amazon-apigateway-request-validator: validateBody
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/JmapRequest" }
            examples:
              queryThenGet:
                value:
                  using:
                    - "urn:ietf:params:jmap:core"
                    - "urn:ietf:params:jmap:mail"
                  methodCalls:
                    - ["Email/query", { "accountId": "6f4c9e2a-8d9f-4c1e-b7a2-4d9c1f6e9e2a", "filter": {}, "sort": [{"property":"receivedAt","isAscending":false}], "limit": 50 }, "c1"]
                    - ["Email/get", { "accountId": "6f4c9e2a-8d9f-4c1e-b7a2-4d9c1f6e9e2a", "ids": ["#c1/ids"] }, "c2"]
      responses:
        "200":
          description: JMAP response
          content:
            application/json:
              schema: { $ref: "#/components/schemas/JmapResponse" }
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalError"
      x-amazon-apigateway-integration:
        type: aws_proxy
        httpMethod: POST
        uri:
          Fn::Sub: >-
            arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${JmapApiFunction.Arn}/invocations
        payloadFormatVersion: "2.0"

  /jmap-iam/{accountId}:
    post:
      tags: [jmap]
      operationId: jmapApiMachineForAccount
      summary: JMAP API endpoint (machine ingest, AWS_IAM)
      description: |
        JMAP API endpoint for machine ingestion, authenticated with AWS_IAM (SigV4).
        Target accountId is provided in the URL path.

        MVP supported methods on this route:
          - Email/import  (ingest)

        Server rules:
          - Path accountId is authoritative (effective accountId).
          - If method args include `accountId`, it must match path accountId (or is rejected).
          - Caller must be an allowed IAM principal (enforced by IAM + optionally checked in code).
      security:
        - SigV4: []
      x-amazon-apigateway-request-validator: validateBodyAndParams
      parameters:
        - name: accountId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/JmapRequest" }
            examples:
              importEmailConceptual:
                summary: Email/import (conceptual; see design doc for blobId strategy)
                value:
                  using:
                    - "urn:ietf:params:jmap:core"
                    - "urn:ietf:params:jmap:mail"
                  methodCalls:
                    - ["Email/import", {
                        "accountId": "6f4c9e2a-8d9f-4c1e-b7a2-4d9c1f6e9e2a",
                        "emails": {
                          "k0": {
                            "blobId": "opaque-blob-id",
                            "keywords": { "$seen": false },
                            "receivedAt": "2026-01-04T00:12:34Z"
                          }
                        }
                      }, "c1"]
      responses:
        "200":
          description: JMAP response
          content:
            application/json:
              schema: { $ref: "#/components/schemas/JmapResponse" }
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "409":
          $ref: "#/components/responses/Conflict"
        "500":
          $ref: "#/components/responses/InternalError"
      x-amazon-apigateway-integration:
        type: aws_proxy
        httpMethod: POST
        uri:
          Fn::Sub: >-
            arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${JmapApiFunction.Arn}/invocations
        payloadFormatVersion: "2.0"

components:
  securitySchemes:
    CognitoUserPool:
      type: apiKey
      in: header
      name: Authorization
      x-amazon-apigateway-authtype: cognito_user_pools
      x-amazon-apigateway-authorizer:
        type: cognito_user_pools
        providerARNs:
          - Fn::Sub: arn:aws:cognito-idp:${AWS::Region}:${AWS::AccountId}:userpool/${CognitoUserPoolId}

    SigV4:
      type: apiKey
      in: header
      name: Authorization
      x-amazon-apigateway-authtype: awsSigv4

  responses:
    BadRequest:
      description: Bad request
      content:
        application/json:
          schema: { $ref: "#/components/schemas/Error" }
          examples:
            bad:
              value: { code: "bad_request", message: "Invalid payload" }
    Unauthorized:
      description: Unauthorized
      content:
        application/json:
          schema: { $ref: "#/components/schemas/Error" }
          examples:
            unauth:
              value: { code: "unauthorized", message: "Missing or invalid token" }
    Forbidden:
      description: Forbidden
      content:
        application/json:
          schema: { $ref: "#/components/schemas/Error" }
          examples:
            forbid:
              value: { code: "forbidden", message: "Not allowed" }
    Conflict:
      description: Conflict
      content:
        application/json:
          schema: { $ref: "#/components/schemas/Error" }
          examples:
            conflict:
              value: { code: "conflict", message: "Conflict" }
    InternalError:
      description: Internal server error
      content:
        application/json:
          schema: { $ref: "#/components/schemas/Error" }
          examples:
            ie:
              value: { code: "internal_error", message: "Unexpected error" }

  schemas:
    Error:
      type: object
      required: [code, message]
      properties:
        code: { type: string }
        message: { type: string }
        details:
          type: object
          additionalProperties: true

    # Minimal JMAP Session shape (enough for standard clients)
    JmapSession:
      type: object
      required: [apiUrl, accounts, capabilities]
      properties:
        apiUrl:
          type: string
          description: Absolute URL to the user's JMAP API endpoint (/jmap).
        state:
          type: string
          description: Session state token.
        capabilities:
          type: object
          additionalProperties: true
        accounts:
          type: object
          description: |
            Map of accountId -> account object.
            Note: accountId is the map key.
          additionalProperties:
            $ref: "#/components/schemas/JmapAccount"

    JmapAccount:
      type: object
      required: [name, isPersonal, isReadOnly, accountCapabilities]
      properties:
        name: { type: string }
        isPersonal: { type: boolean }
        isReadOnly: { type: boolean }
        accountCapabilities:
          type: object
          additionalProperties: true

    # Minimal JMAP request/response envelope
    JmapRequest:
      type: object
      required: [using, methodCalls]
      properties:
        using:
          type: array
          items: { type: string }
        methodCalls:
          type: array
          description: Each entry is [methodName, argumentsObject, callId]
          items:
            type: array
            minItems: 3
            maxItems: 3
            items:
              oneOf:
                - type: string
                - type: object
                - type: string

    JmapResponse:
      type: object
      required: [methodResponses]
      properties:
        methodResponses:
          type: array
          description: Each entry is [methodNameOrError, responseObject, callId]
          items:
            type: array
            minItems: 3
            maxItems: 3
            items:
              oneOf:
                - type: string
                - type: object
                - type: string
        sessionState:
          type: string

x-amazon-apigateway-request-validators:
  validateBody:
    validateRequestBody: true
    validateRequestParameters: false
  validateBodyAndParams:
    validateRequestBody: true
    validateRequestParameters: true

x-amazon-apigateway-gateway-responses:
  DEFAULT_4XX:
    statusCode: 400
    responseTemplates:
      application/json: '{"code":"bad_request","message":"Request rejected"}'
  DEFAULT_5XX:
    statusCode: 500
    responseTemplates:
      application/json: '{"code":"internal_error","message":"Internal error"}'
